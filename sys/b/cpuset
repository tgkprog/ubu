#!/bin/bash
# cpuset - set CPU frequency to closest available level
# usage: sudo ./cpuset <percent>

PERCENT="$1"
[ -z "$PERCENT" ] && { echo "Usage: $0 <percent>"; exit 1; }

# Get available frequencies (sorted descending)
AVAILABLE=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies)
MAX_KHZ=$(echo $AVAILABLE | awk '{print $1}')

# Calculate target frequency
TARGET_KHZ=$(( MAX_KHZ * PERCENT / 100 ))

# Find closest available frequency
CLOSEST=""
CLOSEST_DIFF=999999999
for FREQ in $AVAILABLE; do
    DIFF=$(( TARGET_KHZ - FREQ ))
    [ $DIFF -lt 0 ] && DIFF=$(( -DIFF ))
    if [ $DIFF -lt $CLOSEST_DIFF ]; then
        CLOSEST_DIFF=$DIFF
        CLOSEST=$FREQ
    fi
done

echo "Hardware max  : $MAX_KHZ kHz"
echo "Requested     : $TARGET_KHZ kHz ($PERCENT%)"
echo "Available     : $AVAILABLE"
echo "Setting to    : $CLOSEST kHz ($(( CLOSEST * 100 / MAX_KHZ ))%)"

cpupower frequency-set -u ${CLOSEST}kHz
