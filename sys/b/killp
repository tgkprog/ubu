#!/usr/bin/env python
import subprocess
import sys


def usage() -> None:
    print("Usage: killp <pattern> [signal]", file=sys.stderr)
    sys.exit(1)


if len(sys.argv) < 2:
    usage()

pattern = sys.argv[1]
if len(sys.argv) > 2:
    raw_signal = sys.argv[2]
    signal = raw_signal if raw_signal.startswith("-") else f"-{raw_signal}"
else:
    signal = "-TERM"

try:
    proc = subprocess.run(
        ["sudo", "ps", "-eo", "pid=,args="],
        capture_output=True,
        text=True,
        check=True,
    )
except subprocess.CalledProcessError as exc:
    print(f"Failed to run ps: {exc}", file=sys.stderr)
    sys.exit(exc.returncode)

matches = []
for line in proc.stdout.splitlines():
    line = line.strip()
    if not line:
        continue
    parts = line.split(None, 1)
    if len(parts) != 2:
        continue
    pid, cmdline = parts
    if pattern in cmdline:
        matches.append((pid, cmdline))

if not matches:
    print(f"No processes found containing '{pattern}'.")
    sys.exit(0)

exit_code = 0
for pid, cmdline in matches:
    try:
        subprocess.run(["sudo", "kill", signal, pid], check=True)
        print(f"Sent {signal} to PID {pid}: {cmdline}")
    except subprocess.CalledProcessError as exc:
        exit_code = exc.returncode or 1
        print(f"Failed to kill PID {pid}: {exc}", file=sys.stderr)

sys.exit(exit_code)
