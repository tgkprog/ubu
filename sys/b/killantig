#!/usr/bin/env bash

patterns=("antigravity" "language_server")
signals=("TERM" "KILL")
sleep_duration=15

send_signal() {
  local signal="$1"
  local pattern="$2"
  local pids

  readarray -t pids < <(pgrep -f "$pattern" 2>/dev/null || true)
  if ((${#pids[@]} == 0)); then
    echo "No processes matching '$pattern' for signal $signal"
    return
  fi

  for pid in "${pids[@]}"; do
    [[ -z "$pid" ]] && continue
    local name
    name=$(ps -p "$pid" -o comm= 2>/dev/null || echo "unknown")
    echo "kill -${signal} ${pid} (${name})"
    if ! kill "-$signal" "$pid" 2>/dev/null; then
      echo "Failed to kill PID $pid with -$signal" >&2
    fi
  done
}

for idx in "${!signals[@]}"; do
  signal="${signals[$idx]}"
  for pattern in "${patterns[@]}"; do
    send_signal "$signal" "$pattern"
  done

  if (( idx == 0 )); then
    sleep "$sleep_duration"
  fi
done
